# YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license
# ================================
# ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç½‘ç»œç»“æ„å£°æ˜
# YOLOv5é’ˆå¯¹ä¸åŒå¤§å°ï¼ˆn, s, m, l, xï¼‰çš„ç½‘ç»œæ•´ä½“æ¶æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œ
# äº”ä¸ªæ¨¡å‹æ–‡ä»¶ä¸­ï¼Œanchors,backboneå’Œheadéƒ½æ˜¯ä¸€æ ·çš„
# åŒºåˆ«åœ¨äºï¼Œå­æ¨¡å—ä¸­é‡‡ç”¨ä¸åŒçš„æ·±åº¦å’Œå®½åº¦ï¼Œå¯¹åº”yamlæ–‡ä»¶ä¸­çš„depth_multipleå’Œwidth_multipleå‚æ•°ã€‚å†³å®šäº†æ¨¡å‹çš„å¤æ‚åº¦
# æ˜¯æ·±åº¦å› å­å’Œå®½åº¦å› å­ä¸åŒ
# æ·±åº¦å› å­æ˜¯C3ä¸­bottleneck å—çš„å¤šå°‘
# å®½åº¦å› å­æ˜¯å·ç§¯å±‚çš„é€šé“æ•°
# ================================
# 1ã€å‚æ•°é…ç½® Parameters
nc: 80  # number of classes æ•°æ®é›†ä¸­çš„ç±»åˆ«æ•°
depth_multiple: 0.33  # model depth multiple æ¨¡å‹å±‚æ•°å› å­(ç”¨æ¥è°ƒæ•´ç½‘ç»œçš„æ·±åº¦)
width_multiple: 0.50  # layer channel multiple æ¨¡å‹é€šé“æ•°å› å­(ç”¨æ¥è°ƒæ•´ç½‘ç»œçš„å®½åº¦)

# 2ã€å…ˆéªŒæ¡†é…ç½®
anchors:  # 9ä¸ªanchorï¼Œæ˜¯åŸå§‹å›¾ç‰‡ä¸Šçš„ç›®æ ‡å¤§å°ï¼Œå…¶é—´Pè¡¨æ˜ç‰¹å¾å›¾çš„å±‚çº§ï¼ŒP3/8è¯¥å±‚ç‰¹å¾å›¾ç¼©æ”¾ä¸º1/8,æ˜¯ç¬¬3å±‚ç‰¹å¾
  - [10,13, 16,30, 33,23]  # P3/8 ä¸‹é‡‡æ ·1/8åçš„anchorå¤§å°,æ£€æµ‹å°ç›®æ ‡,10,13æ˜¯ä¸€ç»„å°ºå¯¸ï¼Œæ€»å…±ä¸‰ç»„æ£€æµ‹å°ç›®æ ‡
  - [30,61, 62,45, 59,119]  # P4/16 ä¸‹é‡‡æ ·1/16åçš„anchorå¤§å°,æ£€æµ‹ä¸­ç›®æ ‡ï¼Œå…±ä¸‰ç»„
  - [116,90, 156,198, 373,326]  # P5/32 ä¸‹é‡‡æ ·1/32åçš„anchorå¤§å°,æ£€æµ‹å¤§ç›®æ ‡ï¼Œå…±ä¸‰ç»„

# ================================
# YOLOv5 v6.0 backbone
# 3ã€backboneéƒ¨åˆ†
backbone:
  # from = -1,è¡¨ç¤ºè¾“å…¥æ¥è‡ªä¸Šä¸€å±‚ï¼›from=[-1,6], è¾“å…¥æ¥è‡ªä¸Šä¸€å±‚å’Œç¬¬6å±‚
  # number è¡¨ç¤ºå½“å‰æ¨¡å—çš„å¤ç”¨ä¸ªæ•°ï¼Œå®é™…å¤ç”¨ä¸ªæ•°ç”±numberå’Œå‚æ•°depth_multipleå…±åŒå†³å®šï¼Œå†³å®šå½“å‰æ¨¡å—çš„æ·±åº¦
  # module è¡¨ç¤ºè¯¥å±‚æ¨¡å—çš„åç§°ï¼Œè¿™äº›æ¨¡å—å†™åœ¨common.pyä¸­ï¼Œæ¨¡å—åŒ–çš„æ­å»ºç½‘ç»œ
  # args ç±»çš„åˆå§‹åŒ–å‚æ•°ï¼Œè§£æä½œä¸º module çš„ä¼ å…¥å‚æ•°

  # example:
  # yolov5s ä¸­ depth_multipleè®¾ç½®ä¸ºäº†0.33, width_multipleè®¾ç½®ä¸ºäº†0.5
  # ç¬¬é›¶å±‚ [-1, 1, Conv, [64, 6, 2, 2]]
  # è§£æä¸ºï¼š
  # from = -1,è¡¨ç¤ºè¾“å…¥æ¥è‡ªä¸Šä¸€å±‚
  # number = 1, number * depth_multiple =1 * 0.33 = 0.33, å–1
  # module = "Conv", æ˜¯ä¸€ä¸ªå·ç§¯æ¨¡å—
  # args = [64, 6, 2, 2] -> [3,64*0.5=32,6,2,2]ï¼Œ3ä¸ºè¾“å…¥channelï¼Œ32ä¸ºè¾“å‡ºchannel

  # [from, number, module, args]                                                åŸå§‹è¾“å…¥å›¾ç‰‡ï¼š 640x640@3
  [[-1, 1, Conv, [64, 6, 2, 2]],  # 0-P1/2   [3, 64*0.5=32, 6, 2, 2]            output = 320x320@32
   [-1, 1, Conv, [128, 3, 2]],    # 1-P2/4   [32, 128*0.5=64, 3, 2]             output = 160x160@64
   [-1, 3, C3, [128]],            # 2        [128*0.5=64, 64, 1]
   [-1, 1, Conv, [256, 3, 2]],    # 3-P3/8   [64, 256*0.5=128, 3, 2]            output = 80x80@128
   [-1, 6, C3, [256]],            # 4        [256*0.5=128, 128, 2] ------>æ¥å£
   [-1, 1, Conv, [512, 3, 2]],    # 5-P4/16  [128, 512*0.5=256, 3, 2]           output = 40x40@256
   [-1, 9, C3, [512]],            # 6        [512*0.5=256, 256, 3] ------>æ¥å£
   [-1, 1, Conv, [1024, 3, 2]],   # 7-P5/32  [256, 1024*0.5=512, 3, 2]          output = 20x20@512
   [-1, 3, C3, [1024]],           # 8        [1024*0.5=512, 512, 1]
   [-1, 1, SPPF, [1024, 5]],      # 9        [1024*0.5=512, 512, 5] ------>æ¥å£
  ]

# YOLOv5 v6.0 head
# 4ã€headéƒ¨åˆ†
head:
  # neck
  # å‰ä¸¤ä¸ªé˜¶æ®µæ˜¯å‘ä¸Šconcat
  [[-1, 1, Conv, [512, 1, 1]],                      # 10                [512, 256, 1, 1]                output = 20x20@256
   # nn.upsampleä¸æ”¹å˜channelä½†æ˜¯ä¼šæŠŠfeature mapå®½å’Œé«˜éƒ½å˜ä¸º2å€
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],      # 11                [None, 2, 'nearest']            output = 40x40@256
    # ä¸ä¸Šé¢backboneä¸­çš„ P4é˜¶æ®µçš„æœ€åä¸€ä¸ªè¾“å‡ºåšä¸€ä¸ªconcat
    # è¿›è¡Œconcatçš„ä¸¤å±‚å¿…é¡»å¤§å°ç›¸åŒã€é€šé“æ•°ç›¸åŒ concatä¹‹åé€šé“ç¿»å€
   [[-1, 6], 1, Concat, [1]],                       # 12                [1] cat backbone P4             output = 40x40@512
   [-1, 3, C3, [512, False]],                       # 13                [512, 256, 1, False]            output = 40x40@256

   [-1, 1, Conv, [256, 1, 1]],                      # 14                [256, 128, 1, 1]                output = 40x40@128
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],      # 15                [None, 2, 'nearest']            output = 80x80@128
   [[-1, 4], 1, Concat, [1]],  # cat backbone P3    # 16                [1]  cat backbone P3            output = 80x80@256
   [-1, 3, C3, [256, False]],  # 17 (P3/8-small)    # 17(P3/8-small)    [256, 128, 1, False]            output = 80x80@128

   # åä¸¤ä¸ªé˜¶æ®µæ˜¯å‘ä¸‹concat
   [-1, 1, Conv, [256, 3, 2]],                      # 18                [128, 128, 3, 2]                output = 40x40@128
   [[-1, 14], 1, Concat, [1]],                      # 19                [1] cat head P4                 output = 40x40@256
   [-1, 3, C3, [512, False]],                       # 20(P4/16-medium)  [256, 256, 1, False]

   [-1, 1, Conv, [512, 3, 2]],                      # 21                [256, 256, 3, 2]                output = 20x20@256
   [[-1, 10], 1, Concat, [1]],                      # 22                cat head P5                     output = 20x20@512
   [-1, 3, C3, [1024, False]],                      # 23(P5/32-large)   [512, 512, 1, False]

   # head
   [[17, 20, 23], 1, Detect, [nc, anchors]],        # 24 Detect(P3, P4, P5)  [17,20,23]éƒ½ä¼ å…¥ä½œä¸ºDetectçš„è¾“å…¥
  ]                                                 # [k,k,3,conf+loc+cla]
